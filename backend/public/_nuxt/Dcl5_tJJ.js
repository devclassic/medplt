import{E as N}from"./DZR1yAR-.js";import{E as U,a as F,b as L}from"./CMSMWl0q.js";import{E as O}from"./Dhxcbez2.js";import"./vbLTN4dk.js";import{M as D,E as H,f as K}from"./CyeoGlfr.js";import{_ as j,r as A,j as J,c as f,a as s,b as m,k as o,l as k,y as q,t as _,v as z,m as P,n as G,F as v,s as x,w as c,p as Q,q as W,o as p,z as X,d as g}from"./C-lO5xe2.js";import{a as Y}from"./C0nZT3yk.js";import"./kVpZJ5Aa.js";import"./CV1wHGoe.js";import"./Do2p3T4L.js";import"./5xU2jYLy.js";import"./B_VGWpmo.js";import"./BuyEbX8F.js";import"./Bphrh_KI.js";import"./DJ49jiU5.js";import"./DKKri6B8.js";const Z={class:"wrap"},ee={class:"top-box"},se=["innerHTML"],te={class:"bottom-box"},oe={class:"input-box"},ne={class:"toolbar"},ae={class:"type-list"},le={class:"right"},re={class:"status"},ie=["onKeydown"],ce={class:"speech-box"},me={class:"speech-list"},pe={class:"item"},de={class:"name"},ue={class:"content"},fe={__name:"speech",setup(_e){const e=A({showType:!1,showRename:!1,status:"",prompt:"",names:[],nameValues:[],speechItems:[],result:"",resultRef:J("result")}),b=()=>{let n="";return e.speechItems.forEach(t=>{n+=`${t.name}：${t.text}
`}),`<对话>${n}</对话>`},E=()=>{e.prompt="请根据<对话>生成一份完整的病例",e.showType=!1},R=()=>{e.prompt="",e.showType=!1};let d=!1;const h=Y(),T=async()=>{if(!d)e.status=h.start(()=>{e.status="录音中...",d=!0},()=>{e.status="录音失败...",d=!1});else{e.status="生成对话...";const t=(await h.getResult()).data[0]?.sentence_info;t&&(e.speechItems=t.map(r=>({name:`说话人${r.spk}`,spk:r.spk,text:r.text}))),e.status="",d=!1}},C=()=>{e.names=[...new Set(e.speechItems.map(n=>n.name))],e.showRename=!0},V=()=>{e.speechItems.forEach(n=>{n.name=e.nameValues[e.names.indexOf(n.name)]}),e.showRename=!1},S=D(),I=Q(),w=async()=>{if(!e.prompt){H.error("请输入对话生成提示词");return}e.status="生成中...";const n=`${b()}
${e.prompt}`,t=I.public.BASE_URL+"/api/client/asr/generate",r=new AbortController;let u="";await K(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:n}),signal:r.signal,async onopen(l){if(l.ok&&l.headers.get("content-type")?.includes("text/event-stream"))console.log("✅ SSE opened");else throw new Error(await l.text())},async onmessage(l){try{const i=JSON.parse(l.data);u+=i.answer||"",e.result=S.render(u.replace(/<think>[\s\S]*?<\/think>/g,"")),i.event==="message_end"&&(e.status=""),await W(),e.resultRef.scrollTo({top:e.resultRef.scrollHeight,behavior:"smooth"})}catch{}},onerror(l){console.error(l),r.abort()},onclose(){e.status="",console.log("🔚 SSE closed")}})},$=()=>{e.status="",e.prompt="",e.speechItems=[],e.result=""};return(n,t)=>{const r=N,u=F,l=U,i=L,M=O;return p(),f(v,null,[s("div",Z,[t[8]||(t[8]=s("div",{class:"title"},"多人语音",-1)),s("div",ee,[s("div",{ref:"result",innerHTML:o(e).result,class:"result"},null,8,se)]),s("div",te,[s("div",oe,[s("div",ne,[s("div",null,[s("div",{onClick:t[0]||(t[0]=a=>o(e).showType=!o(e).showType),class:"type"}),k(s("div",ae,[s("div",{onClick:E,class:"item"},[...t[5]||(t[5]=[s("div",{class:"icon icon-mr"},null,-1),s("div",{class:"text"},"病历生成",-1)])]),s("div",{onClick:R,class:"item"},[...t[6]||(t[6]=[s("div",{class:"icon icon-custom"},null,-1),s("div",{class:"text"},"自定义",-1)])]),s("div",{onClick:t[1]||(t[1]=a=>o(e).showType=!1),class:"item"},[...t[7]||(t[7]=[s("div",{class:"icon icon-clean"},null,-1),s("div",{class:"text"},"取消",-1)])])],512),[[q,o(e).showType]])]),s("div",le,[s("div",re,_(o(e).status),1),s("div",{onClick:T,class:"speech"}),s("div",{onClick:$,class:"clean"})])]),k(s("textarea",{"onUpdate:modelValue":t[2]||(t[2]=a=>o(e).prompt=a),onKeydown:P(G(w,["prevent"]),["enter"]),placeholder:"请输入对话生成提示词，对话内容为<对话>",class:"input"},null,40,ie),[[z,o(e).prompt]]),s("div",{class:"bottom"},[s("div",{onClick:w,class:"submit"})])]),s("div",ce,[s("div",{class:"toolbar"},[s("div",{onClick:C,class:"rename"})]),s("div",me,[(p(!0),f(v,null,x(o(e).speechItems,a=>(p(),f("div",pe,[s("span",de,_(a.name)+"：",1),s("span",ue,_(a.text),1)]))),256))])])])]),m(M,{modelValue:o(e).showRename,"onUpdate:modelValue":t[4]||(t[4]=a=>o(e).showRename=a),title:"命名说话人",width:"500"},{footer:c(()=>[m(i,{onClick:t[3]||(t[3]=a=>o(e).showRename=!1)},{default:c(()=>[...t[9]||(t[9]=[g("取消",-1)])]),_:1}),m(i,{type:"primary",onClick:V},{default:c(()=>[...t[10]||(t[10]=[g("确定",-1)])]),_:1})]),default:c(()=>[m(l,{"label-width":"auto"},{default:c(()=>[(p(!0),f(v,null,x(o(e).names,(a,y)=>(p(),X(u,{label:a},{default:c(()=>[m(r,{modelValue:o(e).nameValues[y],"onUpdate:modelValue":B=>o(e).nameValues[y]=B},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["label"]))),256))]),_:1})]),_:1},8,["modelValue"])],64)}}},Me=j(fe,[["__scopeId","data-v-a3e819ce"]]);export{Me as default};
