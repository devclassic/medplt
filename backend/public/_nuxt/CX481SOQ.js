import{E as U}from"./DU06vKIJ.js";import"./CEbQVcMT.js";import{M,E as _,f as L}from"./D9lis7FZ.js";import{_ as V,r as w,g,c,a as s,b as D,F as f,j as y,k as r,l as P,t as B,v as H,m as N,n as O,w as j,p as x,q as A,o as m,s as K}from"#entry";import{u as I,a as J}from"./Cs3dzKIV.js";import"./p4-vezJD.js";import"./C4gErKuu.js";import"./CBheTNdn.js";import"./B3xDuC8R.js";import"./BRE3uSYE.js";import"./CNSWhatW.js";import"./pn8GBfzJ.js";const $={class:"wrap"},q={class:"top-box"},z={ref:"result",class:"result"},G=["innerHTML"],Q={class:"bottom-box"},W={class:"input-box"},X={class:"toolbar"},Y={class:"left"},Z={class:"right"},tt={class:"status"},st=["onKeydown"],et={class:"image-box"},ot={class:"images"},it=["onClick","src"],at=["src"],rt={__name:"img",setup(nt){const b=J(),t=w({messages:[],prompt:"",showPreview:!1,previewUrl:"",images:[],imgs:[],status:"",history:[{role:"system",content:[{type:"text",text:"你是端点科技专业医疗影像助手"}]}],imgFileRef:g("imgfile"),dcmFileRef:g("dcmfile"),resultRef:g("result")}),k=a=>{t.images=[];const e=a.target.files;for(let n=0;n<e.length;n++){const o=e[n];t.images.push(URL.createObjectURL(o))}};let p=!1;const h=I(),R=async()=>{if(!p)t.status=h.start(()=>{t.status="录音中...",p=!0},()=>{t.status="录音失败...",p=!1});else{t.status="正在识别...";const a=await h.getResult();t.prompt=a.data[0].text,t.status="",p=!1}},C=a=>{t.previewUrl=a,t.showPreview=!0},S=()=>{t.messages=[],t.images=[],t.imgs=[],t.status="",t.prompt="",t.history=[{role:"system",content:[{type:"text",text:"你是端点科技专业医疗影像助手"}]}]},E=M(),T=A(),v=async()=>{if(t.images.length===0){_.error("请上传影像");return}if(!t.prompt){_.error("请输入提示词");return}t.messages.push({pos:"right",content:t.prompt}),await x(),t.resultRef.scrollTo({top:t.resultRef.scrollHeight,behavior:"smooth"});const a=w({content:""});t.messages.push(a),t.status="上传影像中...";const e=t.imgFileRef.files;if(e.length>0){const i=new FormData;for(let u=0;u<e.length;u++){const F=e[u];i.append("files",F)}const l=await b.post("/api/client/img/upimg",i,{headers:{"Content-Type":"multipart/form-data"}});t.status="影像上传完成...",t.imgs=l.data.data}t.status="正在处理...";const n=T.public.BASE_URL+"/api/client/img",o=new AbortController;let d="";await L(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:t.prompt,history:t.history,imgs:t.imgs}),signal:o.signal,async onopen(i){if(i.ok&&i.headers.get("content-type")?.includes("text/event-stream"))t.prompt="",console.log("✅ SSE opened");else throw new Error(await i.text())},async onmessage(i){try{const l=JSON.parse(i.data);console.log(l),d+=l.answer||"",a.content=E.render(d.replace(/<think>[\s\S]*?<\/think>/g,"")),l.event==="message_end"&&(t.status=""),await x(),t.resultRef.scrollTo({top:t.resultRef.scrollHeight,behavior:"smooth"})}catch{}},onerror(i){console.error(i),o.abort()},onclose(){t.status="",console.log("🔚 SSE closed")}})};return(a,e)=>{const n=U;return m(),c(f,null,[s("div",$,[e[3]||(e[3]=s("div",{class:"title"},"图像分析",-1)),s("div",q,[s("div",z,[(m(!0),c(f,null,y(r(t).messages,o=>(m(),c("div",{class:K([{right:o.pos==="right"},"item"])},[s("div",{innerHTML:o.content,class:"content"},null,8,G)],2))),256))],512)]),s("div",Q,[s("div",W,[s("div",X,[s("div",Y,[s("input",{onChange:k,ref:"imgfile",type:"file",accept:"image/*",multiple:"",class:"file"},null,544),s("div",{onClick:e[0]||(e[0]=o=>r(t).imgFileRef.click()),class:"upimage"})]),s("div",Z,[s("div",tt,B(r(t).status),1),s("div",{onClick:R,class:"speech"}),s("div",{onClick:S,class:"clean"})])]),P(s("textarea",{"onUpdate:modelValue":e[1]||(e[1]=o=>r(t).prompt=o),onKeydown:N(O(v,["prevent"]),["enter"]),placeholder:"请上传片子并输入相关问题",class:"input"},null,40,st),[[H,r(t).prompt]]),s("div",{class:"bottom"},[s("div",{onClick:v,class:"submit"})])]),s("div",et,[s("div",ot,[(m(!0),c(f,null,y(r(t).images,o=>(m(),c("img",{onClick:d=>C(o),src:o,class:"img"},null,8,it))),256))])])])]),D(n,{modelValue:r(t).showPreview,"onUpdate:modelValue":e[2]||(e[2]=o=>r(t).showPreview=o),title:"图像预览",width:"800"},{default:j(()=>[s("img",{src:r(t).previewUrl,class:"preview"},null,8,at)]),_:1},8,["modelValue"])],64)}}},yt=V(rt,[["__scopeId","data-v-a3268972"]]);export{yt as default};
