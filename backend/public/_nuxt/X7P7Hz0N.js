import{E as j}from"./CEbMfD-a.js";import{E as z,a as J,b as q}from"./OYSGiCz3.js";import{E as P}from"./DNE9nDJw.js";import"./CVOtDZBH.js";import{M as G,E as Q,f as W}from"./CaTnqm11.js";import{z as T,A as B,_ as X,r as Y,j as Z,c as b,a as s,b as w,k as a,l as M,B as ee,t as S,x as te,v as se,m as oe,n as ae,F as E,s as R,w as f,p as ne,q as le,o as y,C as re,d as V}from"./EwCbqKW-.js";import{a as ie}from"./CUsWJ9UZ.js";import"./BwXzaiRm.js";import"./CIa6fhAL.js";import"./Dad0xDRF.js";import"./daoBXWbk.js";import"./DkAOjvrk.js";import"./BuyEbX8F.js";import"./BYrQAmaY.js";import"./DJ49jiU5.js";import"./r1GSfbrt.js";const D=window.setInterval,N=()=>{const i=T(0),e=T(!1);let m=0,c=null;const v=()=>{i.value=Date.now()-m};return{timer:c,elapsed:i,running:e,start:()=>{e.value||(m=Date.now()-i.value,e.value=!0,c=D(v,10))},pause:()=>{e.value&&(clearInterval(c),e.value=!1)},reset:()=>{clearInterval(c),i.value=0,e.value=!1}}},ce=i=>{const e=(g,h=2)=>String(g).padStart(h,"0"),m=e(Math.floor(i/36e5)),c=e(Math.floor(i%36e5/6e4)),v=e(Math.floor(i%6e4/1e3)),p=e(Math.floor(i%1e3/10));return{h:m,m:c,s:v,cent:p,str:`${m}:${c}:${v}.${p}`}},pe=N();B(()=>ce(pe.elapsed.value));const ue={class:"wrap"},me={class:"top-box"},de=["innerHTML"],ve={class:"bottom-box"},fe={class:"input-box"},he={class:"toolbar"},_e={class:"type-list"},we={class:"right"},ye={class:"status"},ge=["onKeydown"],be={class:"speech-box"},xe={class:"speech-list"},ke={class:"item"},Se={class:"name"},Ee={class:"content"},Te={__name:"speech",setup(i){const e=Y({showType:!1,showRename:!1,status:"",prompt:"",names:[],nameValues:[],speechItems:[],result:"",resultRef:Z("result")}),m=()=>{let o="";return e.speechItems.forEach(t=>{o+=`${t.name}：${t.text}
`}),`<对话>${o}</对话>`},c=()=>{e.prompt="请根据<对话>生成一份完整的病例",e.showType=!1},v=()=>{e.prompt="",e.showType=!1},p=N(),g=o=>{const t=(k,n=2)=>String(k).padStart(n,"0"),r=t(Math.floor(o/36e5)),d=t(Math.floor(o%36e5/6e4)),l=t(Math.floor(o%6e4/1e3)),u=t(Math.floor(o%1e3/10));return{h:r,m:d,s:l,cent:u,str:`${r}:${d}:${l}`}},h=B(()=>g(p.elapsed.value)),$=ie();let _=T(!1),x=null;const U=async()=>{if(!_.value)e.status=$.start(()=>{p.start(),e.status=`${h.value.str} 录音中...`,x=D(()=>{e.status=`${h.value.str} 录音中...`},100),_.value=!0},()=>{clearInterval(x),p.reset(),e.status="录音失败...",_.value=!1});else{e.status="生成对话...",clearInterval(x),p.reset();const t=(await $.getResult()).data[0]?.sentence_info;t&&(e.speechItems=t.map(r=>({name:`说话人${r.spk}`,spk:r.spk,text:r.text}))),e.status="",_.value=!1}},F=()=>{e.names=[...new Set(e.speechItems.map(o=>o.name))],e.showRename=!0},L=()=>{e.speechItems.forEach(o=>{o.name=e.nameValues[e.names.indexOf(o.name)]}),e.showRename=!1},O=G(),A=ne(),C=async()=>{if(!e.prompt){Q.error("请输入对话生成提示词");return}e.status="生成中...";const o=`${m()}
${e.prompt}`,t=A.public.BASE_URL+"/api/client/asr/generate",r=new AbortController;let d="";await W(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:o}),signal:r.signal,async onopen(l){if(l.ok&&l.headers.get("content-type")?.includes("text/event-stream"))console.log("✅ SSE opened");else throw new Error(await l.text())},async onmessage(l){try{const u=JSON.parse(l.data);d+=u.answer||"",e.result=O.render(d.replace(/<think>[\s\S]*?<\/think>/g,"")),u.event==="message_end"&&(e.status=""),await le(),e.resultRef.scrollTo({top:e.resultRef.scrollHeight,behavior:"smooth"})}catch{}},onerror(l){console.error(l),r.abort()},onclose(){e.status="",console.log("🔚 SSE closed")}})},H=()=>{e.status="",e.prompt="",e.speechItems=[],e.result=""};return(o,t)=>{const r=j,d=J,l=z,u=q,k=P;return y(),b(E,null,[s("div",ue,[t[8]||(t[8]=s("div",{class:"title"},"多人语音",-1)),s("div",me,[s("div",{ref:"result",innerHTML:a(e).result,class:"result"},null,8,de)]),s("div",ve,[s("div",fe,[s("div",he,[s("div",null,[s("div",{onClick:t[0]||(t[0]=n=>a(e).showType=!a(e).showType),class:"type"}),M(s("div",_e,[s("div",{onClick:c,class:"item"},[...t[5]||(t[5]=[s("div",{class:"icon icon-mr"},null,-1),s("div",{class:"text"},"病历生成",-1)])]),s("div",{onClick:v,class:"item"},[...t[6]||(t[6]=[s("div",{class:"icon icon-custom"},null,-1),s("div",{class:"text"},"自定义",-1)])]),s("div",{onClick:t[1]||(t[1]=n=>a(e).showType=!1),class:"item"},[...t[7]||(t[7]=[s("div",{class:"icon icon-clean"},null,-1),s("div",{class:"text"},"取消",-1)])])],512),[[ee,a(e).showType]])]),s("div",we,[s("div",ye,S(a(e).status),1),s("div",{onClick:U,class:te([{active:a(_)},"speech"])},null,2),s("div",{onClick:H,class:"clean"})])]),M(s("textarea",{"onUpdate:modelValue":t[2]||(t[2]=n=>a(e).prompt=n),onKeydown:oe(ae(C,["prevent"]),["enter"]),placeholder:"请输入对话生成提示词，对话内容为<对话>",class:"input"},null,40,ge),[[se,a(e).prompt]]),s("div",{class:"bottom"},[s("div",{onClick:C,class:"submit"})])]),s("div",be,[s("div",{class:"toolbar"},[s("div",{onClick:F,class:"rename"})]),s("div",xe,[(y(!0),b(E,null,R(a(e).speechItems,n=>(y(),b("div",ke,[s("span",Se,S(n.name)+"：",1),s("span",Ee,S(n.text),1)]))),256))])])])]),w(k,{modelValue:a(e).showRename,"onUpdate:modelValue":t[4]||(t[4]=n=>a(e).showRename=n),title:"命名说话人",width:"500"},{footer:f(()=>[w(u,{onClick:t[3]||(t[3]=n=>a(e).showRename=!1)},{default:f(()=>[...t[9]||(t[9]=[V("取消",-1)])]),_:1}),w(u,{type:"primary",onClick:L},{default:f(()=>[...t[10]||(t[10]=[V("确定",-1)])]),_:1})]),default:f(()=>[w(l,{"label-width":"auto"},{default:f(()=>[(y(!0),b(E,null,R(a(e).names,(n,I)=>(y(),re(d,{label:n},{default:f(()=>[w(r,{modelValue:a(e).nameValues[I],"onUpdate:modelValue":K=>a(e).nameValues[I]=K},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["label"]))),256))]),_:1})]),_:1},8,["modelValue"])],64)}}},je=X(Te,[["__scopeId","data-v-95bb194b"]]);export{je as default};
